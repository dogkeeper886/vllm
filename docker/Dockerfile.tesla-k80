# Dockerfile for Tesla K80 support with vLLM
# Uses CUDA 11.4.3 on Rocky Linux 8 - last CUDA version supporting Tesla K80
FROM nvidia/cuda:11.4.3-devel-rockylinux8

# Set environment variables
ENV PYTHONUNBUFFERED=1
ENV CUDA_HOME=/usr/local/cuda
ENV PATH=/usr/local/cuda/bin:$PATH
ENV LD_LIBRARY_PATH=/usr/local/cuda/lib64:$LD_LIBRARY_PATH

# Set CUDA architecture for Tesla K80 (compute capability 3.7)
ENV TORCH_CUDA_ARCH_LIST="3.7"
ENV CUDA_ARCH_LIST="3.7"

# Install system dependencies
RUN dnf update -y && \
    dnf install -y \
        python3.9 \
        python3.9-pip \
        python3.9-devel \
        git \
        wget \
        gcc \
        gcc-c++ \
        make \
        cmake \
        which \
        ninja-build \
        && \
    dnf clean all

# Create symlinks for python
RUN ln -sf /usr/bin/python3.9 /usr/bin/python3 && \
    ln -sf /usr/bin/python3.9 /usr/bin/python && \
    ln -sf /usr/bin/pip3.9 /usr/bin/pip3 && \
    ln -sf /usr/bin/pip3.9 /usr/bin/pip

# Upgrade pip
RUN python -m pip install --upgrade pip

# Install PyTorch with CUDA 11.3 support (compatible with 11.4 and Tesla K80)
# Using older PyTorch version that still supports compute capability 3.7
RUN pip install torch==1.12.1+cu113 torchvision==0.13.1+cu113 torchaudio==0.12.1 \
    --extra-index-url https://download.pytorch.org/whl/cu113

# Install other dependencies needed for vLLM
RUN pip install \
    ninja \
    packaging \
    wheel \
    flash-attn==2.3.6 \
    xformers==0.0.20 \
    transformers \
    tokenizers \
    sentencepiece \
    numpy \
    psutil \
    ray

# Set working directory
WORKDIR /workspace

# Copy vLLM source code
COPY . /workspace/vllm/

# Set working directory to vLLM
WORKDIR /workspace/vllm

# Build vLLM with Tesla K80 support
# Force compilation for compute capability 3.7
RUN TORCH_CUDA_ARCH_LIST="3.7" \
    CUDA_ARCH_LIST="3.7" \
    MAX_JOBS=4 \
    python setup.py develop

# Set the default command
CMD ["python", "-c", "import vllm; print('vLLM with Tesla K80 support ready!')"]

# Add labels for documentation
LABEL maintainer="Tesla K80 Support"
LABEL description="vLLM with Tesla K80 (compute capability 3.7) support on Rocky Linux 8"
LABEL cuda.version="11.4.3"
LABEL gpu.arch="Tesla K80"
LABEL compute.capability="3.7"