# Tesla K80 vLLM Docker Image
# Multi-stage build for Tesla K80 (compute capability 3.7) support

# Build stage
FROM vllm-tesla-k80-builder:latest as builder

# Copy vLLM source code
COPY . /workspace/vllm/
WORKDIR /workspace/vllm

# Initialize git repository for version detection
RUN git init . && \
    git config user.email "builder@tesla-k80.local" && \
    git config user.name "Tesla K80 Builder" && \
    git add . && \
    git commit -m "Initial commit for build"

# Build vLLM CUDA extensions only (dependencies already in builder)
# Skip build isolation and dependency downloads - all deps pre-installed in builder
# Disable Flash Attention and other features that require CUDA 11.6+
RUN TORCH_CUDA_ARCH_LIST="3.7" \
    CUDA_ARCH_LIST="3.7" \
    VLLM_TARGET_DEVICE="cuda" \
    VLLM_USE_FLASH_ATTN_V2=0 \
    CMAKE_ARGS="-DCMAKE_VERBOSE_MAKEFILE=ON -DVLLM_USE_FLASH_ATTN_V2=OFF" \
    MAX_JOBS=4 \
    pip install --no-build-isolation --no-deps -e .

# Runtime stage
FROM nvidia/cuda:11.4.3-runtime-ubuntu20.04

# Avoid interactive prompts
ARG DEBIAN_FRONTEND=noninteractive

# Tesla K80 runtime environment
ENV CUDA_HOME=/usr/local/cuda
ENV PATH=/usr/local/cuda/bin:$PATH
ENV LD_LIBRARY_PATH=/usr/local/cuda/lib64:$LD_LIBRARY_PATH

# Install minimal runtime dependencies
RUN apt-get update && apt-get install -y \
    python3.9 \
    python3.9-distutils \
    && rm -rf /var/lib/apt/lists/*

# Set Python 3.9 as default
RUN update-alternatives --install /usr/bin/python python /usr/bin/python3.9 1 && \
    update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3.9 1

# Copy Python environment from builder
COPY --from=builder /usr/local/lib/python3.9/dist-packages/ /usr/local/lib/python3.9/dist-packages/
COPY --from=builder /usr/local/bin/ /usr/local/bin/
COPY --from=builder /workspace/vllm/ /workspace/vllm/

# Set working directory
WORKDIR /workspace/vllm

# Default command
CMD ["python", "-c", "import vllm; print('vLLM Tesla K80 ready!')"]

# Labels
LABEL maintainer="Tesla K80 Support"
LABEL description="vLLM with Tesla K80 (compute capability 3.7) support"
LABEL cuda.version="11.4.3"
LABEL compute.capability="3.7"
LABEL driver.version="470"