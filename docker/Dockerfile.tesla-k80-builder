# Tesla K80 Builder Environment
# CUDA 11.4 + cuDNN 8.2 + Driver 470 compatible build environment for Tesla K80 support

FROM nvidia/cuda:11.4.3-cudnn8-devel-ubuntu20.04

# Avoid interactive prompts during build
ARG DEBIAN_FRONTEND=noninteractive

# Tesla K80 environment variables
ENV CUDA_HOME=/usr/local/cuda
ENV PATH=/usr/local/cuda/bin:$PATH
ENV LD_LIBRARY_PATH=/usr/local/cuda/lib64:$LD_LIBRARY_PATH
ENV TORCH_CUDA_ARCH_LIST="3.7"
ENV CUDA_ARCH_LIST="3.7"

# Install system dependencies
RUN apt-get update && apt-get install -y \
    python3.9 \
    python3.9-dev \
    python3.9-distutils \
    python3-pip \
    git \
    build-essential \
    cmake \
    ninja-build \
    curl \
    wget \
    && rm -rf /var/lib/apt/lists/*

# Set Python 3.9 as default
RUN update-alternatives --install /usr/bin/python python /usr/bin/python3.9 1 && \
    update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3.9 1

# Upgrade pip
RUN python -m pip install --upgrade pip setuptools wheel

# Install CUDA-enabled PyTorch for Tesla K80
# Use CUDA 11.3 build which is compatible with CUDA 11.4 runtime
RUN pip install torch==1.12.1+cu113 torchvision==0.13.1+cu113 \
    --extra-index-url https://download.pytorch.org/whl/cu113

# Copy requirements files to pre-install all dependencies  
COPY requirements/common.txt /tmp/requirements/common.txt
COPY requirements/cuda.txt /tmp/requirements/cuda.txt
COPY requirements/build.txt /tmp/requirements/build.txt

# Install all vLLM requirements in builder to avoid downloads during main build
RUN pip install -r /tmp/requirements/build.txt && \
    pip install -r /tmp/requirements/cuda.txt && \
    pip install \
    ninja \
    packaging \
    setuptools-scm \
    "numpy<2" \
    cmake

# Set working directory
WORKDIR /workspace

LABEL maintainer="Tesla K80 Support"
LABEL description="Build environment for Tesla K80 (compute capability 3.7)"
LABEL cuda.version="11.4.3"
LABEL pytorch.version="1.12.1"
LABEL compute.capability="3.7"